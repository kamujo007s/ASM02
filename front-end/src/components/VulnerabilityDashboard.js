//VulnerabilityDashboard.js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import RiskBarChart from './Graphs/RiskBarChart';
import RiskPieChart from './Graphs/RiskPieChart';
import RiskLineChart from './Graphs/RiskLineChart';
import { Card, Row, Col, ConfigProvider, theme } from 'antd';
import CWEBreakdownChart from './Graphs/CWEBreakdownChart'; // Chart สำหรับ CWE
import AttackVectorChart from './Graphs/AttackVectorChart'; // Chart สำหรับ Attack Vector
import UnpatchedProductsTable from './Graphs/UnpatchedProductsTable'; // Table สำหรับ Unpatched Products

const VulnerabilityDashboard = () => {
  const [summary, setSummary] = useState([]);
  const [assetsDataOverTime, setAssetsDataOverTime] = useState([]);
  const [groupedSummary, setGroupedSummary] = useState({});
  const [cweData, setCweData] = useState([]); // ข้อมูลสำหรับ CWE Breakdown
  const [vectorData, setVectorData] = useState([]); // ข้อมูลสำหรับ Attack Vector Analysis
  const [unpatchedProducts, setUnpatchedProducts] = useState([]); // ข้อมูลสำหรับ Unpatched Products

  useEffect(() => {
    fetchSummary();
    fetchAssetsOverTime();
    fetchCweBreakdown(); // ดึงข้อมูล CWE
    fetchAttackVector(); // ดึงข้อมูล Attack Vector
    fetchUnpatchedProducts(); // ดึงข้อมูล Unpatched Products
  }, []);

  const fetchSummary = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await axios.get('http://192.168.1.164:3012/cve/vulnerability-summary', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const sortedSummary = response.data.sort((a, b) => {
        if (a.operating_system === b.operating_system) {
          return a.os_version.localeCompare(b.os_version);
        }
        return a.operating_system.localeCompare(b.operating_system);
      });

      const grouped = groupByOS(sortedSummary);
      setGroupedSummary(grouped);
    } catch (error) {
      console.error('Error fetching vulnerability summary:', error);
    }
  };

  const fetchAssetsOverTime = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await axios.get('http://192.168.1.164:3012/cve/asset-over-time', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      setAssetsDataOverTime(response.data);
    } catch (error) {
      console.error('Error fetching asset data over time:', error);
    }
  };

  const fetchCweBreakdown = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await axios.get('http://192.168.1.164:3012/cve/cwe-breakdown', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      setCweData(response.data);
    } catch (error) {
      console.error('Error fetching CWE breakdown:', error);
    }
  };

  const fetchAttackVector = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await axios.get('http://192.168.1.164:3012/cve/attack-vector', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      setVectorData(response.data);
    } catch (error) {
      console.error('Error fetching attack vector data:', error);
    }
  };

  const fetchUnpatchedProducts = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await axios.get('http://192.168.1.164:3012/cve/unpatched-products', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      setUnpatchedProducts(response.data);
    } catch (error) {
      console.error('Error fetching unpatched products:', error);
    }
  };

  const groupByOS = (summaryData) => {
    const grouped = {};
    summaryData.forEach(({ operating_system, riskLevels, totalCount, os_version }) => {
      if (!grouped[operating_system]) {
        grouped[operating_system] = [];
      }
      grouped[operating_system].push({ os_version, riskLevels, totalCount });
    });
    return grouped;
  };

  return (
    <ConfigProvider
      theme={{
        token: {
          colorPrimary: "#1677ff",
          colorInfo: "#1677ff",
          colorTextBase: "#000000",
          colorBgBase: "#ffffff",
          borderRadius: 6,
          wireframe: false,
        },
      }}
    >
      <div className="container mt-5" style={{ color: '#1f1f1f', margin: '2% 5%' }}>
        <h3>Vulnerability Risk Summary by OS and Version</h3>

        {/* Row 1: Summary by OS */}
        <Row gutter={[24, 24]} style={{ marginBottom: '40px' }}>
          {Object.keys(groupedSummary).map((osName) => (
            <Col span={24} key={osName}>
              <Card title={osName} bordered={false} style={{ backgroundColor: '#fff' }}>
                <Row gutter={[16, 16]}>
                  {groupedSummary[osName].map(({ os_version, riskLevels, totalCount }, index) => (
                    <Col key={index} span={8}>
                      <h6>{os_version ? `Version: ${os_version}` : 'Unknown Version'}</h6>
                      <Row gutter={[8, 16]}>
                        <Col span={12}>
                          <RiskBarChart riskLevels={riskLevels} osName={osName} version={os_version} />
                        </Col>
                        <Col span={12}>
                          <RiskPieChart riskLevels={riskLevels} />
                        </Col>
                      </Row>
                      <p style={{ marginTop: '16px' }}>
                        <strong>Total Vulnerabilities:</strong> {totalCount}
                      </p>
                    </Col>
                  ))}
                </Row>
              </Card>
            </Col>
          ))}
        </Row>

        {/* Row 2: Line Chart for Asset Count Over Time */}
        <div style={{ marginTop: '40px', marginBottom: '60px' }}>
          <h3>Asset Count Over Time</h3>
          <Card bordered={false} style={{ backgroundColor: '#fff' }}>
            <RiskLineChart assetsDataOverTime={assetsDataOverTime} />
          </Card>
        </div>

        {/* Row 3: CWE Breakdown */}
        <div style={{ marginTop: '40px' }}>
          <h3>CWE Breakdown</h3>
          <Card bordered={false} style={{ backgroundColor: '#fff' }}>
            <CWEBreakdownChart cweData={cweData} /> {/* ส่งข้อมูล cweData ไปยังแผนภูมิ */}
          </Card>
        </div>

        {/* Row 4: Attack Vector Analysis */}
        <div style={{ marginTop: '40px' }}>
          <h3>Attack Vector Analysis</h3>
          <Card bordered={false} style={{ backgroundColor: '#fff' }}>
            <AttackVectorChart vectorData={vectorData} /> {/* ส่งข้อมูล vectorData ไปยังแผนภูมิ */}
          </Card>
        </div>

        {/* Row 5: Unpatched Products */}
        <div style={{ marginTop: '40px' }}>
          <h3>Unpatched or End-of-Life Products</h3>
          <Card bordered={false} style={{ backgroundColor: '#fff' }}>
            <UnpatchedProductsTable productsData={unpatchedProducts} /> {/* ส่งข้อมูล unpatchedProducts ไปยังตาราง */}
          </Card>
        </div>
      </div>
    </ConfigProvider>
  );
};

export default VulnerabilityDashboard;
