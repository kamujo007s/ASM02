import React, { useState, useEffect } from "react";
import axios from "axios";
import { Row, Col, Card, ConfigProvider, theme } from "antd";
import UnpatchedVulnerabilitiesTable from "./Charts/UnpatchedVulnerabilitiesTable";
import ImpactScoreBarChart from "./Charts/ImpactScoreBarChart";
import CVSSSeverityBarChart from "./Charts/CVSSSeverityBarChart";
import VulnerabilitiesOverTimeLineChart from "./Charts/VulnerabilitiesOverTimeLineChart";
import Top5OSCurrentYearTable from "./Charts/Top5OSCurrentYearTable";
import Top5OSCurrentYearChart from "./Charts/Top5OSCurrentYearChart";

const VulnerabilityDashboard2 = () => {
  const [cvssData, setCvssData] = useState([]);
  const [vulnerabilitiesOverTime, setVulnerabilitiesOverTime] = useState([]);
  const [unpatchedData, setUnpatchedData] = useState([]);
  const [impactData, setImpactData] = useState([]);

  useEffect(() => {
    fetchCvssData();
    fetchVulnerabilitiesOverTime();
    fetchUnpatchedData();
    fetchImpactData();
  }, []);

  const fetchCvssData = async () => {
    const token = localStorage.getItem("token");
    const response = await axios.get(
      "http://localhost:3012/cve/cvss-data",
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );
    setCvssData(response.data || []); // fallback เป็น array ว่าง
    console.log("CVSS data:", response.data);
  };

  const fetchVulnerabilitiesOverTime = async () => {
    const token = localStorage.getItem("token");
    const response = await axios.get(
      "http://localhost:3012/cve/asset-over-time",
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );
    setVulnerabilitiesOverTime(response.data || []); // fallback เป็น array ว่าง
    console.log("Vulnerabilities over time:", response.data);
  };


  const fetchUnpatchedData = async () => {
    const token = localStorage.getItem("token");
    const response = await axios.get(
      "http://localhost:3012/cve/unpatched-products",
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );
    setUnpatchedData(response.data || []); // fallback เป็น array ว่าง
    console.log("Unpatched data:", response.data);
  };



  const fetchImpactData = async () => {
    try {
      const token = localStorage.getItem("token");
      const response = await axios.get(
        "http://localhost:3012/cve/impact-score",
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setImpactData(response.data);
      console.log("Impact data:", response.data);
    } catch (error) {
      console.error("Failed to fetch impact data:", error);
      alert("Error fetching impact score data: " + error.message); // แสดงข้อความแจ้งเตือนเมื่อเกิดข้อผิดพลาด
    }
  };


  return (
    <ConfigProvider theme={{ algorithm: theme.defaultAlgorithm }}>
      <div
        className="container mt-5"
        style={{ color: "#1f1f1f", margin: "2% 5%" }}
      >
        <Row gutter={[24, 24]}>
          <Col span={12}>
            <Card title="Vulnerability Severity by CVSS Score" bordered={false}>
              <CVSSSeverityBarChart cvssData={cvssData} />
            </Card>
          </Col>
          <Col span={12}>
            <Card title="Vulnerabilities Over Time" bordered={false}>
              <VulnerabilitiesOverTimeLineChart
                vulnerabilitiesData={vulnerabilitiesOverTime}
              />
            </Card>
          </Col>
        </Row>


        <Row gutter={[24, 24]}>
          <Col span={12}>
            <Card title="Unpatched Vulnerabilities" bordered={false}>
              <UnpatchedVulnerabilitiesTable unpatchedData={unpatchedData} />
            </Card>
          </Col>
          <Col span={12}>
            <Card title="Impact Score Analysis" bordered={false}>
              <ImpactScoreBarChart impactData={impactData} />
            </Card>
          </Col>
        </Row>

        <Row gutter={[24, 24]}>
          <Col span={12}>
            <Card
              bordered={false}
            >
              <Top5OSCurrentYearTable />
            </Card>
          </Col>
          <Col span={12}>
            <Card
              bordered={false}
            >
              <Top5OSCurrentYearChart />
            </Card>
          </Col>
        </Row>
      </div>
    </ConfigProvider>
  );
};

export default VulnerabilityDashboard2;
